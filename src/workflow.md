# File Transfer Workflow Documentation

## T·ªïng quan

D·ª± √°n n√†y bao g·ªìm hai th√†nh ph·∫ßn ch√≠nh:
- **Client (C#)**: `src_client_c#/` - ·ª®ng d·ª•ng Unity game client
- **Server (Java)**: `src_server_java/` - Server game Java

## Workflow Chuy·ªÉn T·ªáp Gi·ªØa Client v√† Server

### 1. Ki·∫øn tr√∫c Network

#### Client Side (C#)
- **Session Management**: S·ª≠ d·ª•ng `Session_ME.cs` v√† `Session_ME2.cs` ƒë·ªÉ qu·∫£n l√Ω k·∫øt n·ªëi
- **Message Handling**: `Controller.cs` x·ª≠ l√Ω c√°c message t·ª´ server
- **Service Layer**: `Service.cs` cung c·∫•p c√°c API ƒë·ªÉ g·ª≠i request

#### Server Side (Java)
- **Network Layer**: Package `network/` ch·ª©a c√°c class qu·∫£n l√Ω k·∫øt n·ªëi
- **Message Processing**: `MessageSendCollect.java` x·ª≠ l√Ω vi·ªác g·ª≠i/nh·∫≠n message
- **Session Management**: `Session.java` v√† `Sender.java` qu·∫£n l√Ω session

### 2. Quy tr√¨nh Chuy·ªÉn T·ªáp

#### B∆∞·ªõc 1: Client Request Resources
```csharp
// Service.cs - Client g·ª≠i request resource
public void getResource(sbyte action, MyVector vResourceIndex)
{
    Message message = new Message((sbyte)(-74));
    message.writer().writeByte(action);
    session.sendMessage(message);
}
```

#### B∆∞·ªõc 2: Server X·ª≠ l√Ω Request
```java
// Controller.java - Server nh·∫≠n v√† x·ª≠ l√Ω command -74
case -74:
    byte type = _msg.reader().readByte();
    if (type == 1) {
        DataGame.sendSizeRes(_session);
    } else if (type == 2) {
        DataGame.sendRes(_session);
    }
    break;
```

#### B∆∞·ªõc 3: Server G·ª≠i Resource Data
```java
// DataGame.java - Server g·ª≠i resource files
public static void sendRes(MySession session) {
    for (final File fileEntry : new File("data/girlkun/res/x" + session.zoomLevel).listFiles()) {
        String original = fileEntry.getName();
        byte[] res = FileIO.readFile(fileEntry.getAbsolutePath());
        msg = new Message(-74);
        msg.writer().writeByte(2);
        msg.writer().writeUTF(original);
        msg.writer().writeInt(res.length);
        msg.writer().write(res);
        session.sendMessage(msg);
        Thread.sleep(5);
    }
}
```

#### B∆∞·ªõc 4: Client Nh·∫≠n v√† L∆∞u Resource
```csharp
// Controller.cs - Client x·ª≠ l√Ω nh·∫≠n resource
case -74:
    sbyte b25 = msg.reader().readByte();
    if (b25 == 2) {
        string original = msg.reader().readUTF();
        string[] array4 = Res.split(original, "/", 0);
        string filename = "x" + mGraphics.zoomLevel + array4[array4.Length - 1];
        int num44 = msg.reader().readInt();
        sbyte[] data2 = new sbyte[num44];
        msg.reader().read(ref data2, 0, num44);
        Rms.saveRMS(filename, data2);
    }
    break;
```

### 3. C√°c Lo·∫°i Resource Transfer

#### 3.1 Resource Files (-74 command)
- **Action 0**: G·ª≠i version resource
- **Action 1**: G·ª≠i s·ªë l∆∞·ª£ng files
- **Action 2**: G·ª≠i t·ª´ng file resource
- **Action 3**: Ho√†n th√†nh transfer

#### 3.2 Image Files (66 command)
```java
// Server g·ª≠i image theo t√™n
public static void sendImageByName(MySession session, String imgName) {
    byte[] data = FileIO.readFile("data/girlkun/img_by_name/x" + session.zoomLevel + "/" + imgName + ".png");
    msg.writer().writeUTF(imgName);
    msg.writer().writeInt(data.length);
    msg.writer().write(data);
}
```

#### 3.3 Icon Files (-67 command)
```java
// Server g·ª≠i icon theo ID
public static void sendIcon(MySession session, int id) {
    byte[] data = FileIO.readFile("data/girlkun/icon/x" + session.zoomLevel + "/" + id + ".png");
    msg.writer().writeInt(data.length);
    msg.writer().write(data);
}
```

### 4. Encryption v√† Security

#### Key Exchange
```csharp
// Client g·ª≠i key request
doSendMessage(new Message(-27));

// Server x·ª≠ l√Ω key exchange
if (msg.command == -27) {
    this.session.sendKey();
}
```

#### Message Encryption
```csharp
// Client encrypt/decrypt
if (getKeyComplete) {
    b = readKey(b);
    // Encrypt message data
}
```

### 5. File Storage

#### Client Storage
- S·ª≠ d·ª•ng `Rms.saveRMS()` ƒë·ªÉ l∆∞u files locally
- Files ƒë∆∞·ª£c l∆∞u theo zoom level: `x{zoomLevel}filename`
- Version ƒë∆∞·ª£c l∆∞u trong `ResVersion`

#### Server Storage
- Resource files: `data/girlkun/res/x{zoomLevel}/`
- Image files: `data/girlkun/img_by_name/x{zoomLevel}/`
- Icon files: `data/girlkun/icon/x{zoomLevel}/`

### 6. Error Handling

#### Client Side
```csharp
try {
    // File transfer logic
} catch (Exception) {
    GameCanvas.startOK(mResources.pls_restart_game_error, 8885, null);
}
```

#### Server Side
```java
try {
    // File transfer logic
} catch (Exception e) {
    Logger.logException(DataGame.class, e);
}
```

### 7. Performance Optimization

#### Client Side
- S·ª≠ d·ª•ng `Thread.Sleep(5)` ƒë·ªÉ tr√°nh spam
- Progress tracking v·ªõi `ServerListScreen.percent`
- Batch processing v·ªõi `MyVector`

#### Server Side
- S·ª≠ d·ª•ng `Thread.sleep(5)` gi·ªØa c√°c file
- Buffer size optimization: `socket.setSendBufferSize(1_048_576)`
- Non-blocking message queue v·ªõi `LinkedBlockingDeque`

### 8. Monitoring v√† Debug

#### Client Debug
```csharp
Res.outz("SEND MSG: " + message.command);
Debug.Log("GET DATA SERVER");
```

#### Server Debug
```java
System.out.println("üîç JAVA DEBUG SEND: command=" + msg.command);
System.out.println("üîç JAVA DEBUG RECEIVE: raw command=" + cmd);
```

## K·∫øt lu·∫≠n

Workflow chuy·ªÉn t·ªáp gi·ªØa client C# v√† server Java ƒë∆∞·ª£c thi·∫øt k·∫ø v·ªõi:
- **Reliability**: Error handling v√† retry mechanism
- **Security**: Encryption v·ªõi key exchange
- **Performance**: Optimized buffer v√† threading
- **Scalability**: Modular design v·ªõi separation of concerns
- **Monitoring**: Comprehensive logging v√† debug information

H·ªá th·ªëng h·ªó tr·ª£ nhi·ªÅu lo·∫°i resource kh√°c nhau v√† c√≥ kh·∫£ nƒÉng m·ªü r·ªông ƒë·ªÉ th√™m c√°c lo·∫°i file transfer m·ªõi.

## Workflow ƒêƒÉng Nh·∫≠p

### 1. Client Side - Quy tr√¨nh ƒêƒÉng Nh·∫≠p

#### B∆∞·ªõc 1: Ng∆∞·ªùi d√πng nh·∫≠p th√¥ng tin ƒëƒÉng nh·∫≠p
```csharp
// LoginScr.cs - Ng∆∞·ªùi d√πng nh·∫≠p username/password v√†o TField
public TField tfUser;  // Text field cho username
public TField tfPass;  // Text field cho password
```

#### B∆∞·ªõc 2: Client x·ª≠ l√Ω th√¥ng tin ƒëƒÉng nh·∫≠p
```csharp
// LoginScr.cs - doLogin() method
public void doLogin()
{
    // ƒê·ªçc th√¥ng tin t·ª´ RMS (local storage)
    string text = Rms.loadRMSString("acc");
    string text2 = Rms.loadRMSString("pass");
    
    // Ki·ªÉm tra lo·∫°i ƒëƒÉng nh·∫≠p (normal vs login2)
    if (text != null && !text.Equals(string.Empty))
    {
        isLogin2 = false;
    }
    else if (Rms.loadRMSString("userAo" + ServerListScreen.ipSelect) != null)
    {
        isLogin2 = true;
    }
    
    // Validation
    if (text == null || text2 == null || GameMidlet.VERSION == null)
    {
        return;
    }
    
    // K·∫øt n·ªëi v√† g·ª≠i request ƒëƒÉng nh·∫≠p
    GameCanvas.connect();
    Service.gI().login(text, text2, GameMidlet.VERSION, (sbyte)(isLogin2 ? 1 : 0));
}
```

#### B∆∞·ªõc 3: Client g·ª≠i request ƒëƒÉng nh·∫≠p
```csharp
// Service.cs - login() method
public void login(string username, string pass, string version, sbyte type)
{
    Message message = messageNotLogin(0);  // Command -29 v·ªõi sub-command 0
    message.writer().writeUTF(username);
    message.writer().writeUTF(pass);
    message.writer().writeUTF(version);
    message.writer().writeByte(type);
    session.sendMessage(message);
}
```

### 2. Server Side - X·ª≠ l√Ω ƒêƒÉng Nh·∫≠p

#### B∆∞·ªõc 1: Server nh·∫≠n request ƒëƒÉng nh·∫≠p
```java
// Controller.java - messageNotLogin() method
public void messageNotLogin(MySession session, Message msg) {
    byte cmd = msg.reader().readByte();
    switch (cmd) {
        case 0:  // Login request
            session.login(
                msg.reader().readUTF(),  // username
                msg.reader().readUTF()   // password
            );
            break;
    }
}
```

#### B∆∞·ªõc 2: Server x·ª≠ l√Ω ƒëƒÉng nh·∫≠p
```java
// MySession.java - login() method
public void login(String username, String password) {
    // Ki·ªÉm tra Anti-Login (ch·ªëng spam)
    AntiLogin al = ANTILOGIN.get(this.ipAddress);
    if (!al.canLogin()) {
        Service.gI().sendThongBaoOK(this, al.getNotifyCannotLogin());
        return;
    }
    
    // Ki·ªÉm tra server maintenance
    if (Maintenance.isRuning) {
        Service.gI().sendThongBaoOK(this, "Server ƒëang b·∫£o tr√¨");
        return;
    }
    
    // Ki·ªÉm tra s·ªë l∆∞·ª£ng player
    if (!this.isAdmin && Client.gI().getPlayers().size() >= Manager.MAX_PLAYER) {
        Service.gI().sendThongBaoOK(this, "Server qu√° t·∫£i");
        return;
    }
    
    // Th·ª±c hi·ªán ƒëƒÉng nh·∫≠p
    Player pl = GodGK.login(this, al);
    if (pl != null) {
        // G·ª≠i d·ªØ li·ªáu game cho client
        DataGame.sendSmallVersion(this);
        DataGame.sendVersionGame(this);
        DataGame.sendDataItemBG(this);
        
        // Thi·∫øt l·∫≠p player
        pl.setSession(this);
        Client.gI().put(pl);
        this.player = pl;
        
        // G·ª≠i th√¥ng b√°o th√†nh c√¥ng
        Logger.warning("Successful login for player " + this.player.name);
    }
}
```

#### B∆∞·ªõc 3: Database Authentication
```java
// GodGK.java - login() method
public static synchronized Player login(MySession session, AntiLogin al) {
    // Ki·ªÉm tra th√¥ng tin ƒëƒÉng nh·∫≠p trong database
    // T·∫°o Player object n·∫øu ƒëƒÉng nh·∫≠p th√†nh c√¥ng
    // Tr·∫£ v·ªÅ null n·∫øu th·∫•t b·∫°i
}
```

### 3. C√°c B∆∞·ªõc B·∫£o M·∫≠t

#### Anti-Login Protection
```java
// AntiLogin.java - Ch·ªëng spam ƒëƒÉng nh·∫≠p
public boolean canLogin() {
    // Ki·ªÉm tra s·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai trong th·ªùi gian ng·∫Øn
    // Ch·∫∑n IP n·∫øu ƒëƒÉng nh·∫≠p sai qu√° nhi·ªÅu l·∫ßn
}
```

#### Version Check
```java
// Ki·ªÉm tra version client
if (clientVersion != 999) {
    Service.gI().sendThongBaoOK(this, "Vui l√≤ng c·∫≠p nh·∫≠t game!");
    return;
}
```

#### Server Capacity Check
```java
// Ki·ªÉm tra s·ªë l∆∞·ª£ng player hi·ªán t·∫°i
if (Client.gI().getPlayers().size() >= Manager.MAX_PLAYER) {
    Service.gI().sendThongBaoOK(this, "Server qu√° t·∫£i");
    return;
}
```

### 4. Response Flow

#### Th√†nh c√¥ng:
1. Server g·ª≠i d·ªØ li·ªáu game (version, items, maps, etc.)
2. Client nh·∫≠n v√† l∆∞u d·ªØ li·ªáu
3. Chuy·ªÉn sang m√†n h√¨nh ch·ªçn nh√¢n v·∫≠t

#### Th·∫•t b·∫°i:
1. Server g·ª≠i th√¥ng b√°o l·ªói
2. Client hi·ªÉn th·ªã dialog l·ªói
3. Ng∆∞·ªùi d√πng c√≥ th·ªÉ th·ª≠ l·∫°i

### 5. L∆∞u tr·ªØ th√¥ng tin ƒëƒÉng nh·∫≠p

#### Client Side
```csharp
// L∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p
public void savePass()
{
    if (isCheck) {
        Rms.saveRMSString("acc", tfUser.getText().ToLower().Trim());
        Rms.saveRMSString("pass", tfPass.getText().ToLower().Trim());
    }
}
```

#### Server Side
```java
// C·∫≠p nh·∫≠t th√¥ng tin ƒëƒÉng nh·∫≠p trong database
GirlkunDB.executeUpdate("update account set last_time_login = '" + 
    new Timestamp(System.currentTimeMillis()) + 
    "', ip_address = '" + session.ipAddress + "' where id = " + session.userId);
```

## Command ƒêƒÉng Nh·∫≠p

### Client ‚Üí Server
- **-29,0**: Login
- **-29,2**: Set Client Type

### Server ‚Üí Client (Success)
- **-77**: Small Version
- **-93**: Background Item Version
- **-28**: Game Version
- **-31**: Item Background Data
- **-87**: Game Data

### Server ‚Üí Client (Error)
- **sendThongBaoOK**: Error Messages

### Flow
```
Client: -29,0
    ‚Üì
Server: Validation
    ‚Üì
Success: -77 ‚Üí -93 ‚Üí -28 ‚Üí -31 ‚Üí -87
    ‚Üì
Error: sendThongBaoOK
```

## Command Sau Login

### Client ‚Üí Server
- **13**: Client OK (Ready)

### Server ‚Üí Client (After Client OK)
- **-3**: Player Info
- **-68**: Send Money
- **-69**: Send Money
- **-64**: Flag Bag
- **-113**: Skill Shortcut
- **-116**: Item Time
- **-106**: Item Time
- **-60**: Skill Data
- **-45**: Skill Effect
- **-124**: Map Effect
- **-112**: Map Effect
- **-95**: Zone Info
- **-105**: Zone Info
- **-6**: Map Info
- **-30**: Sub Command
- **-22**: Chat
- **-96**: Boss Info
- **-119**: Time Info

### Flow Sau Login
```
Client: 13 (Client OK)
    ‚Üì
Server: Send Player Data
    ‚Üì
Server: -3 ‚Üí -68 ‚Üí -69 ‚Üí -64 ‚Üí -113 ‚Üí -116 ‚Üí -106
    ‚Üì
Server: -60 ‚Üí -45 ‚Üí -124 ‚Üí -112 ‚Üí -95 ‚Üí -105 ‚Üí -6
    ‚Üì
Server: -30 ‚Üí -22 ‚Üí -96 ‚Üí -119
```